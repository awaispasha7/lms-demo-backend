{% extends 'assignments/base.html' %}

{% block title %}Create Assignment - LMS Demo{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Create New Assignment</h1>
        <p class="text-gray-600 mt-2">Create a new assignment with questions</p>
    </div>

    <form id="assignment-form" class="bg-white rounded-lg shadow-lg p-6" x-data="assignmentForm()">
        <div class="space-y-6">
            <div>
                <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                    Assignment Title <span class="text-red-500">*</span>
                </label>
                <input type="text" id="title" x-model="formData.title" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Description
                </label>
                <textarea id="description" x-model="formData.description" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            <div>
                <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2">
                    Due Date
                </label>
                <input type="datetime-local" id="due_date" x-model="formData.dueDate"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <div>
                <div class="flex justify-between items-center mb-4">
                    <label class="block text-sm font-medium text-gray-700">
                        Questions <span class="text-red-500">*</span>
                    </label>
                    <button type="button" @click="addQuestion()" 
                            class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Question
                    </button>
                </div>

                <div class="space-y-4">
                    <template x-for="(question, index) in formData.questions" :key="index">
                        <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-semibold text-gray-900" x-text="`Question ${index + 1}`"></h4>
                                <button type="button" @click="removeQuestion(index)" 
                                        class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Question Text <span class="text-red-500">*</span></label>
                                    <textarea x-model="question.questionText" required rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
                                    <select x-model="question.type" 
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                                        <option value="mcq">Multiple Choice</option>
                                        <option value="true_false">True/False</option>
                                        <option value="short_answer">Short Answer</option>
                                    </select>
                                </div>

                                <div x-show="question.type !== 'short_answer'">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Options <span class="text-red-500">*</span></label>
                                    <template x-for="(option, optIndex) in question.options" :key="optIndex">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <input type="text" x-model="question.options[optIndex]" 
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                                            <button type="button" @click="question.options.splice(optIndex, 1)"
                                                    class="text-red-600 hover:text-red-800">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </template>
                                    <button type="button" @click="question.options.push('')"
                                            class="text-sm text-indigo-600 hover:text-indigo-800">
                                        + Add Option
                                    </button>
                                </div>

                                <div x-show="question.type !== 'short_answer'">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Correct Options <span class="text-red-500">*</span></label>
                                    <div class="space-y-1">
                                        <template x-for="(option, optIndex) in question.options" :key="optIndex">
                                            <label class="flex items-center">
                                                <input type="checkbox" :value="optIndex" x-model="question.correctOptions"
                                                       class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                <span class="ml-2 text-sm text-gray-700" x-text="option"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Rubric/Explanation <span class="text-red-500">*</span></label>
                                    <textarea x-model="question.rubric" required rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500"></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Marks <span class="text-red-500">*</span></label>
                                    <input type="number" x-model="question.marks" min="1" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                <a href="/teacher" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 shadow-md hover:shadow-lg transition-all">
                    Create Assignment
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function assignmentForm() {
    return {
        formData: {
            title: '',
            description: '',
            dueDate: '',
            questions: []
        },
        addQuestion() {
            this.formData.questions.push({
                questionText: '',
                type: 'mcq',
                options: ['', ''],
                correctOptions: [],
                rubric: '',
                marks: 1
            });
        },
        removeQuestion(index) {
            this.formData.questions.splice(index, 1);
        },
        async submitForm() {
            const form = document.getElementById('assignment-form');
            const formData = new FormData();
            
            // Convert to JSON
            const data = {
                title: this.formData.title,
                description: this.formData.description,
                dueDate: this.formData.dueDate,
                questions: this.formData.questions.map((q, idx) => ({
                    questionNumber: idx + 1,
                    questionText: q.questionText,
                    type: q.type,
                    options: q.options.filter(opt => opt.trim() !== ''),
                    correctOptions: q.correctOptions.map(Number),
                    rubric: q.rubric,
                    marks: parseInt(q.marks)
                }))
            };
            
            try {
                const apiUrl = window.BACKEND_API_URL || '';
                const response = await fetch(`${apiUrl}/api/teacher/assignments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    window.location.href = '/teacher';
                } else {
                    alert('Error creating assignment');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating assignment');
            }
        },
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}

document.getElementById('assignment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = Alpine.$data(document.querySelector('[x-data]'));
    form.submitForm();
});
</script>
{% endblock %}

